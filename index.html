<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shortener</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>
        body { padding: 20px; }
        #shortenedUrl { margin-top: 1em; }
        #err {margin-top: 0.5em;}
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <h1 class="title has-text-centered">URL Shortener</h1>

            <div class="field">
                <label class="label">Long URL:</label>
                <div class="control">
                    <input id="urlInput" class="input" type="text" placeholder="Enter URL to shorten">
                </div>
            </div>

            <div class="field">
                <div class="control">
                    <button id="shortenButton" class="button is-primary is-fullwidth">Shorten</button>
                </div>
            </div>

            <div id="shortenedUrl" class="notification is-success" style="display: none;">
              Shortened URL: <a id="shortUrlLink" target="_blank"></a>
            </div>
             <p id="err" class="help is-danger"></p>

        </div>
    </section>

    <script>
        const getUrl = () => {
            const urlInput = document.getElementById("urlInput");
            if (!urlInput) return null;
            let url = urlInput.value.trim();
            if (!url) return null;
            const protocolOk = url.startsWith("http://") || url.startsWith("https://") || url.startsWith("ftp://");
            return protocolOk ? url : "http://" + url;
        };

        const getRandom = () => {
            let text = "";
            const possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            for (let i = 0; i < 5; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        };

        const generateShortCode = () => {
            let shortCode;
            do {
                shortCode = getRandom();
            } while (localStorage.getItem(shortCode));
            return shortCode;
        };

         const updateShortenedUrlDisplay = (shortUrl) => {
           const shortenedUrlDiv = document.getElementById("shortenedUrl");
           const shortUrlLink = document.getElementById("shortUrlLink");
                         shortenedUrlDiv.style.display = 'block';
              shortUrlLink.href = shortUrl;
            shortUrlLink.innerText = shortUrl;
           shortenedUrlDiv.classList.remove('is-hidden');

       };
       const displayError = (message) => {
              document.getElementById('err').innerHTML = message;
       };
        const shortenUrl = () => {
            const longUrl = getUrl();
            if (!longUrl) {
                displayError("Please enter a valid URL.");
                return;
            }
           displayError("");

            const shortCode = generateShortCode();
            localStorage.setItem(shortCode, longUrl);
            const shortUrl = window.location.origin + window.location.pathname + "#" + shortCode;
            updateShortenedUrlDisplay(shortUrl);
        };

        const handleRedirect = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const longUrlFromParams = urlParams.get('url');

            if (longUrlFromParams) {
                const shortCode = generateShortCode();
                localStorage.setItem(shortCode, longUrlFromParams);
                const shortUrl = window.location.origin + window.location.pathname + "#" + shortCode;
                const jsonResponse = { shortUrl: shortUrl };
                document.body.innerHTML = `<pre>${JSON.stringify(jsonResponse, null, 2)}</pre>`;
                return;
            }

            const hash = window.location.hash.substring(1);
            if (hash) {
                const longUrl = localStorage.getItem(hash);
                if (longUrl) {
                    window.location.replace(longUrl);
                } else {
                      document.getElementById("shortenedUrl").style.display = 'block';
                      document.getElementById("shortenedUrl").innerHTML =  "URL Not found.";
                   }
            }
        };


        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById("shortenButton").addEventListener("click", shortenUrl);
            handleRedirect();
        });
    </script>
</body>
</html>
